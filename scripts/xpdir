#!/usr/bin/env python2.3
import os, sys
import plearn.utilities.toolkit as toolkit

expdir_prefix   = "expdir" 
metainfos_fname = "metainfos.txt"

class Metainfos:
    def __init__( self, path, find ):
        self.path  = path
        self.infos = self.parse_file( os.path.join(path, metainfos_fname),
                                      find
                                      )

    def parse_file( self, mipath, find ):
        if not os.path.exists( mipath ):
            return [ "    Experiment still running\n" ]

        infos = []
        for line in file(mipath, "r"):
            lhs_len = line.find( "=" )
            lhs     = line[:lhs_len]
            
            if not find or toolkit.find_one(lhs, find) is not None:
                infos.append( "    %s"%line )

        return infos

    def __cmp__( self, other ):
        if self.path == other.path:
            return 0
        
        len_o = len(other.infos)
        
        for (i, info) in enumerate(self.infos):
            if i == len_o:
                return 1

            oinfo = other.infos[i]
            if info != oinfo:
                return cmp(info, oinfo)

        ## Non-Positive ( <= or == )
        return len(self.infos) - len_o
        
    def __str__( self ):
        return "%s\n%s\n" % ( self.path,
                              "".join( self.infos )
                              )

def start( targets ):
    meta = []
    
    files = os.listdir( os.getcwd() )    
    for fname in files:
        if fname.startswith( expdir_prefix ):
            meta.append( Metainfos(fname, targets) )            

        meta.sort()
    print "\n".join( [ str(m) for m in meta ] )
        
### Main program
start( sys.argv[1:] )
