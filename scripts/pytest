#!/usr/bin/env python2.3
import shutil, glob, time, os, string, sys, fpformat, signal, types

import plearn.utilities.plpath   as plpath
import plearn.utilities.toolkit  as toolkit

from plearn.pytest                       import *
from plearn.tasks.dispatch               import *
from plearn.utilities.verbosity          import *
from plearn.utilities.global_variables   import *


############################################################
# Module variables

globalvars.all_roots                      = [ plpath.plearndir,
                                              plpath.lisaplearndir,
                                              plpath.apstatdir      ]
globalvars.dispatch                       = None
globalvars.options                        = None
globalvars.targets                        = None
globalvars.current_mode                   = None

## ## Should be moved to a field in a Mode's subclass.
## globalvars.modes_with_config = {
##     'compile':CompileTest,
##     'results':ResultsTest,
##     'run':RunTest,
##     'sync':SyncTest
##     }

## globalvars.management_modes = {
##     'add': add_test, ##AddTest,
##     'disable' : disable_test,
##     'enable' : enable_test
##     }

mode_routine_mappings = {
    'add'     : AddTestRoutine, ##add_test,
    'compile' : CompilationRoutine,
    'disable' : disable_test,
    'enable'  : enable_test,
    'results' : ResultsCreationRoutine,
    'run'     : RunTestRoutine#,
#    'sync'    : SyncTest
    }

#####################
## Functions are listed by alphabetical order

def build_tests(mode_name, directory, dirlist):
    toolkit.exempt_list_of( dirlist, Routine.forbidden_directories() )
    
    os.chdir(directory)

    config = config_file_path()
    if config in dirlist:
        execfile(config)
    
    if mode_name == "add":
        Test( name    = globalvars.options.test_name,
              program = GlobalCompilableProgram( name = "plearn")  )        


def check_directory(dirc):
    absdir = os.path.abspath(dirc)
    if ( not os.path.isdir(absdir) or
         string.find(absdir, 'test_suite') == -1 ):
        raise ValueError( "Target %s\n" "is not a valid test_suite subdirectory."
                          % absdir )
    return absdir

def commit_mode():
    pdir, pvar = plpath.splitprev(plpath.pytest_variables)
    os.chdir(pdir)
    cvs_commit(pvar, 'PyTest internal commit')
    sys.exit()
    
def common_preprocessing():
    if globalvars.options.mail != None:
        globalvars.options.savelog = mailing_log

    if globalvars.options.savelog:
        savelog_file = open(globalvars.options.savelog,'w')
          
    if globalvars.options.mail:
        if globalvars.current_mode.name != "compilePLL":
            vprint("The mail option is only supported under the compilePLL mode", 0)
            sys.exit()
        if globalvars.options.savelog:
            vprint("Mail and savelog options are not compatible", 0)
            sys.exit()

def dispatch_targets():
    if globalvars.current_mode.name == 'commit':
        globalvars.options.localhost = True        

    globalvars.dispatch = Dispatch(
        localhost = globalvars.options.localhost,
        nb_hosts  = globalvars.options.hosts
        )
    
    ## --all: Run all tests found in subdirectories of directories in
    ## globalvars.all_roots test_suite branches. If some targets are
    ## provided, these will be ignored.
    if globalvars.options.all:
        globalvars.targets           = globalvars.all_roots
        globalvars.options.recursive = True

    ## If no targets are provided, the cwd is the default target.
    if len(globalvars.targets) == 0:
        globalvars.targets.append( os.getcwd() )

    if globalvars.options.recursive:
        globalvars.targets = remove_subdirs(globalvars.targets)
        
    for target in globalvars.targets:
        if globalvars.options.recursive:
            os.path.walk(target, build_tests, globalvars.current_mode.name)
        else:
            build_tests(globalvars.current_mode.name, target, os.listdir(target))

    for (test_name, test) in Test.instances_map.iteritems():
        RoutineType = mode_routine_mappings[globalvars.current_mode.name]
        globalvars.dispatch.add_task( RoutineType(test) )
    globalvars.dispatch.run()

def dynamic_version_header():
    # Dynamic version header
    c = lambda s: string.center(s, 45)
    vprint( "\n[ %s ]\n[ %s ]\n[ %s ]\n"
            % ( c("PyTest -- version " + pytest_version()),
                c("(c) 2004 Christian Dorion"),
                c("Report problems to dorionc@apstat.com") ),
            0
            )

def mail():
    # Opening the senmail process
    sendmail = Popen3("sendmail -t", True)

    # "Header" of the mail
    sendmail.tochild.write("From: PyTest -compilePLL -mail\n")
    sendmail.tochild.write("Subject: PyTest -- List of files that did not compile\n")
    sendmail.tochild.write("To: " + globalvars.options.mail + "\n")

    # Changing the mode of the savelog_file from write to read
    savelog_file.close()
    savelog_file = open(globalvars.options.savelog, "r")

    # "Body" of the mail
    sendmail.tochild.write(savelog_file.read() + "\n")
    sendmail.tochild.write(".\n")

    # "Closing" the mail mode
    sendmail.tochild.close()
    savelog_file.close()
    globalvars.options.savelog = None # that way the file isn't closed twice
    #                      # ( see end of pytest() )

def pytest_version():
    version_str = '$Id: pytest,v 1.18 2004/10/24 22:57:55 dorionc Exp $'

    bflag = "pytest,v"
    the_year = time.localtime()[0]

    begin = string.find(version_str, bflag) + len(bflag)
    end = string.find(version_str, str(the_year))

    return string.strip( version_str[begin:end] )

def quiet_sys(cmdString):
    os.system(cmdString + " > /dev/null")

def remove_subdirs(absdirs):
    ldirs = len(absdirs)
    to_remove = []
    for i in range(ldirs):
        for j in range(ldirs):
            if i==j:
                continue
            if string.find(absdirs[i], absdirs[j]) != -1:
                vprint("%s is a subdirectory of %s: ignored."
                       % (absdirs[i], absdirs[j]), 2)
                to_remove.append(absdirs[i])

    for r in to_remove:
        absdirs.remove(r)
    return absdirs

def testing_options():
    testing_options = OptionGroup( parser, "Testing Options",
                                   "Available under all modes BUT commit." )
    
    testing_options.add_option( "--all",
                                action="store_true", default=False,
                                help= "Run all tests found in subdirectories of directories in "
                                "globalvars.all_roots test_suite branches. If some targets "
                                "are provided, these will be ignored. " 
                                )
    
    testing_options.add_option( "-R", "--recursive",
                                action="store_true", default=False,
                                help = 'Process all targets recursively. If some target is '
                                'the subdirectory to another target, it will be ignored, i.e. '
                                'the whole hierarchy will be tested only once.'
                                ) 
    
    testing_options.add_option( '-l', '--localhost',
                                action='store_true',
                                help='This flag triggers a dispatch using only the local host. '
                                'CURRENTLY ALWAYS TRUE!!!',
                                default=True )
    
    testing_options.add_option( '--hosts', 
                                help='The maximum nuber of hosts to use simultaneously.',
                                default=10 )
    
    testing_options.add_option( '-n', '--test-name',
                                help='Restricts the current mode to the named test.',
                                default='' )
    
    testing_options.add_option( '-v', "--verbosity",
                                choices=["0", "1", "2"], default="1",
                                help="Selects the level of verbosity among [0, 1, 2], "
                                "1 being the default value. Level 0 is very quiet, while level 2 "
                                "is mainly intended for debug."
                                )
    
    testing_options.add_option("--mail", default=None,
                               help='Not supported yet.')

    return testing_options

###################################################################################
## MAIN PROGRAM
parser = ModeAndOptionParser( usage = "%prog mode [options] target*",
                              version = "%prog " + pytest_version(),
                              with_config_mode=False )

for (mode, mode_routine) in mode_routine_mappings.iteritems():
    option_groups = []
##     if mode == 'add':
##         raw_input("Add command line options...")
        ##option_groups = [ get_add_options(parser) ]
                  
    parser.add_mode( mode, dispatch_targets,
                     help          = toolkit.short_doc(mode_routine),
                     description   = toolkit.doc(mode_routine),
                     option_groups = option_groups
                    )

parser.add_mode( 'commit', commit_mode,
                 help='Commits PyTest internal modifications (ex: disabled test)',
                 description='Commits PyTest internal modifications (ex: disabled test)',
                 max_targets=0 )

parser.add_option_group( testing_options() )

############################################################
##################### Parsing Options ######################

globalvars.options, globalvars.targets = parser.parse_args()
globalvars.current_mode                = parser.selected_mode()

############################################################
################## Some preprocessing ######################

## Managing the verbosity option.
set_verbosity( globalvars.options.verbosity )

if globalvars.options.mail is not None:
    ## vprint.keep_output()
    raise NotImplementedError


############################################################
# Launching the selected mode: The main part of the program
############################################################

## Program name and copyrights with version number
dynamic_version_header()

try:
    parser.launch_selected_mode()    
    while globalvars.current_mode.isAlive():
        time.sleep(0.2)
        
except KeyboardInterrupt, kex:
    print "Interupted by user."
    sys.exit()

############################################################
################## Some postprocessing #####################

vprint("\n%s" % str(Test.statistics), 0)    
vprint("Quitting PyTest.", 1)
kept = vprint.close()    
if kept is not None:
    for k in kept:
        print k
    raise NotImplementedError('mail not implemented yet')
    
